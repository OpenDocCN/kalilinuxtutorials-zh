# Metabadger:通过自动升级到更安全的实例元数据服务 V2 (IMDSv2 ),防止对 AWS EC2 的 SSRF 攻击

> 原文：<https://kalilinuxtutorials.com/metabadger/>

[![](img//1aee42196f24650e3009c8b203916cb4.png)](https://www.blogger.com/blog/post/edit/1980184639205218685/7009012641885962644?pli=1#)

**Metabadger** 通过自动升级到更安全的实例元数据服务 v2 (IMDSv2)来防止对 AWS EC2 的 SSRF 攻击。

**Metabadger**

目的和功能

*   诊断和评估 AWS 实例元数据服务的当前使用情况，并了解该服务的工作方式
*   准备升级到实例元数据服务的 v2，以防范 v1 攻击媒介
*   使您能够专门更新实例，以便只使用 IMDSv2
*   让您能够在不需要的地方禁用实例元数据服务，以减少攻击面

**什么是 AWS 实例元数据服务？**

*   AWS 元数据服务本质上允许您访问实例中的所有内容，包括实例角色凭证和会话令牌
*   利用这种攻击并将其作为进入您环境的支点的已知 SSRF 漏洞
*   您已经听说过的著名攻击，其中一些涉及到通过具有实例元数据服务访问权限的易受攻击的 web 应用程序获取访问权限的方法
*   攻击者可以从元数据服务获取所述凭证，并在特定实例之外使用它们

**IMDSv2 以及为什么要使用它**

*   通过在配置中要求实例始终使用元数据服务的 V2，确保实例始终使用元数据服务
*   使用带有 AWS 元数据 API 的强制请求头的 PUT 请求来启用会话令牌，IMDSv1 不会对此进行检查，这使得攻击者更容易利用该服务
*   IMDSv2 中不允许 X-Forwarded-For 标头，以确保不允许基于代理的流量与元数据服务进行通信

**问题陈述**

工程团队可能在 AWS 中有各种各样的计算基础设施，他们需要防止利用元数据服务的某些漏洞。如果使用了任何 IAM，或者实例在启动时可能需要任何用户数据信息，则需要在实例上运行元数据服务。限制实例的攻击面对于防止通过窃取服务本身提供的信息在您的环境中转移至关重要。过去许多著名的攻击都利用这种特定的服务来利用附加到实例的角色，或者转储可通过元数据服务访问的敏感数据。Metabadger 有助于确定您在何处以及如何使用实例元数据服务，同时还能减少任何不必要的攻击，从而降低您在 EC2 中运行时的总体风险状况。

**免责声明和回滚**

使用此工具可能会影响您的 AWS 计算基础架构，因为不是所有的服务和应用程序都可以在没有元数据服务或版本 2 的情况下工作。在您的生产环境中部署时要小心，并准备好回滚计划，以防出现异常情况。Metabadger 内置了使用-v1 标志回滚到服务的默认版本 1 的能力，您可以使用它来快速回滚实例以使用默认版本。理想情况下，您应该在非生产环境中运行此工具并更新您的元数据版本，作为应用它之前的试验场。

**硬化引导步骤**

**第一步**

最初，我们希望发现我们在特定 AWS 区域中元数据服务的总体使用情况。Metabadger 将评估您的凭证在您的`**/.aws/credentials**`文件中所指向的区域中的当前使用状态或所承担的当前角色。如果您想切换到不同于当前配置的另一个区域，也可以在运行`**discover-metadata**`命令时指定`**--region**`标志。一旦您很好地了解了您的实例运行的版本，以及服务是启用还是禁用，您将能够为强化服务制定一个更加明确的行动计划。请注意，您可以找到这里设置的每个元数据选项的特定含义。

**第二步**

当切换到服务的 v2 时，应该评估的一个方面是 IAM 角色的使用。Metabadger 允许您识别区域中可能已经在使用 IAM 角色的实例。`**discover-role-usage**`命令将输出一个带有角色的实例列表。如果您有许多使用角色的实例，您应该在将服务更新到 v2 时采取预防措施，以确保您的工作负载的整体功能不会受到影响。

**第三步**

完成初始发现和评估后，您现在可以创建一个分阶段的方法来强化您的计算基础架构，以使用元数据服务的 v2 或在可能不使用它的地方禁用它。默认情况下，`**harden**-**metadata**`命令允许您更新特定区域中的所有实例。您还可以使用`**--tag**s`标志或者包含您想要应用配置的实例的 csv 的输入文件来传递实例标记。对 v2 进行适当的更新并禁用不使用的服务后，您可以使用步骤 1 中的项目进行重新评估，以确认您的环境已锁定。如果您不想更新某些实例，您可以通过标签或实例 id 的`--exclusion`标志来排除它们。

**要求**

Metabadger 需要具有以下权限的 IAM 角色或凭据:

**ec2:修改实例属性**
**ec2:描述实例**

在对实例元数据服务进行更改时，您应该小心谨慎，并遵循 AWS 提供的有关如何安全升级到版本 2 的其他指导。Metabadger 旨在帮助您完成这一过程，以进一步保护您在 AWS 中的计算基础架构。

更新到 IMDSv2 的 AWS 最佳实践指南

**用途&安装**

**通过 pip 安装**

**pip3 安装–用户元适配器**

**通过 Github 安装**

**$ git 克隆 https://github.com/salesforce/metabadger
$ CD metabadger
$ pip install-e .
$ Metabadger
用法:Metabadger【选项】命令【ARGS】……
Metabadger 是一个 AWS 安全工具，用于发现和加固
实例元数据服务。
选项:
–版本显示版本并退出。
–帮助显示此消息并退出。
命令:
disable-metadata 禁用 EC2 实例上的 IMDS 服务
discover-metadata 发现 EC2 内 IMDS 服务使用情况的摘要
discover-role-usage 发现 EC2 的 IAM 角色使用情况的摘要
harden-metadata 将 AWS 实例元数据服务从 v1 强化到 v2**

**命令**

**发现-元数据**

总体实例元数据服务使用情况的概要，包括版本和总体实施百分比。使用这些数字将有助于您了解元数据使用的总体状况，以及您在哪里实施 v2 与 v1。

**选项:
-a，–all-region 提供 AWS 帐户中所有可用区域的元数据摘要
-j，–json 获取 JSON 格式的元数据摘要
-r，–region TEXT 指定您将在
的哪个 AWS 区域执行此命令，profile TEXT 指定 AWS IAM 概要文件。**

**发现-角色-用途**

实例和它们所使用的角色的摘要，这将使您很好地了解在对元数据服务本身进行更新时必须小心谨慎。

**选项:
-p，–配置文件文本指定 AWS IAM 配置文件。
-r，–区域文本指定您将在**的哪个 AWS 区域执行该命令

**硬化-元数据**

修改实例以使用元数据 v1 或 v2 的能力，以及了解通过运行模拟运行模式将修改多少实例的能力。

**选项:
-a，–所有区域更新您帐户中所有区域的 IMDS
-e，–排除排除标志将应用于除指定内容之外的所有内容，标签或实例
-d，–预演预演强化元数据更改
-v1，–v1 强制实施元数据服务的 v1
-I，–实例的 csv 文件的输入文件路径路径为
-t，–标签文本逗号分隔的标签列表以将强化设置应用于
-r， –区域文本指定您将在
-p 中执行该命令的 AWS 区域，–配置文件文本指定 AWS IAM 配置文件。**

**禁用-元数据**

使用此命令完全禁用实例上的元数据服务

**选项:
-e，–exclusion 排除标志将应用于除指定内容之外的所有内容，标签或实例
-d，–试运行试运行禁用元数据服务
-i，–输入文件路径实例的 csv 文件路径禁用
的 IMDS，-t，–标签文本逗号分隔的标签列表，将强化设置应用于
-r，–区域文本指定将在哪个 AWS 区域执行此命令
-p，–配置文件文本指定 AWS IAM 配置文件。**

**测井**

Metabadger 所做的所有更改将被记录到保存在工作目录中的一个名为 **`metabadger.log`的文件中。**对于工具在更改元数据服务时采取的每个操作，该文件将包含以下内容:

*   进行更改时的时间和日期戳
*   发生的更改(禁用、强化或更新)
*   进行更改的实例 ID
*   预演信息
*   更改是否成功的状态

[**Download**](https://github.com/salesforce/metabadger)