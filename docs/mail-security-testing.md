# 邮件安全测试–邮件安全和过滤解决方案框架

> 原文：<https://kalilinuxtutorials.com/mail-security-testing/>

邮件安全测试框架是一个邮件安全和过滤解决方案的测试框架。

## **邮件安全测试安装**

邮件安全测试框架适用于 Python >=3.5 的。只需打开这个存储库，然后继续。不需要更多的依赖关系。

## **用途**

脚本 *mail-tester.py* 运行测试。用`**./mail-tester.py --help**`阅读帮助信息，用`**./mail-tester.py -l**`检查测试和规避模块列表，以获得关于脚本功能和用法的概述。一些提示:

*   对于最小测试运行，至少应给出参数`**--smtp-server**`和`**--to**`。
*   所有参数也可以存储在没有前缀`--`的配置文件中。这些配置文件可以通过调用`**./mail-tester.py @tester.conf**`(配置包含在 *tester.conf* 中)来使用。
*   可以使用`**--to**`配置多个接收器，以测试不同的过滤器配置。
*   一些邮件过滤解决方案可能会在一段时间后拒绝邮件。使用 **`--auto-delay`** 对邮件进行自动节流。这个可以用`**--delay-step**`**`--delay-max`**和`**--delay**`来微调。
*   一些测试(垃圾邮件和恶意软件)需要样本。将它们放在目录中，并用`**--spam-folder**`和`**--malware-folder**`参数配置这些目录。这些样本不包括在这个存储库中(将来也不会)。获得恶意软件的好地方是动物园、Das Malwerk 或其他收藏。垃圾邮件可以直接从你的垃圾邮件文件夹中导出，但必须是 EML 格式。
*   黑名单可以与`**--blacklist**`参数一起提供，并用作发送者地址。
*   Shellshock 和 subject XSS 测试用例应该有一个有效的 backconnect 域，在这里您可以看到任何 back connect(特别是 DNS 请求)。免费的金丝雀代币服务可用于此目的。感谢 Thinkst 提供这一令人敬畏的服务！
*   使用`**--evasion content-disposition**`可以启用一些巧妙的附件识别规避技巧。这些在过去被用来混淆反病毒/沙盒解决方案，让他们通过恶意邮件。
*   不要忘记用`**--log**`记录测试结果。邮件过滤提供程序经常在 SMTP 对话框中拒绝邮件，这反映在生成的日志中。
*   测试用例可以用 **`--output`** 作为普通文件转储到一个目录中，格式为 MBox **( `--mbox` )** 或 MailDir ( `**--maildir**`)格式。这对于在不发送任何邮件的情况下测试邮件用户代理、记录或审查生成的测试用例是非常有用的。

**又读[social box——一个暴力攻击框架【脸书，Gmail，Instagram，Twitter】](https://kalilinuxtutorials.com/socialbox-bruteforce-attack/)**

## **开发&邮件安全测试扩展** 

### **测试**

可以用一个类来实现自己的测试，这个类位于`**tests/**`目录中现有的或者新创建的 Python 文件中。该类必须是位于该项目`**tests.base**`模块中 **`MailTestBase`** 的子类。当类变量 **`active`** 被设置为`**True**`时，新实现的测试被自动发现。此外(如果您计划将测试提交回主存储库)，应该适当地设置类变量*标识符*、*名称*和*描述*。

下列基类包含用于重写的方法或类变量:

*   `**MailTestBase**`:一般测试的测试类。
    *   `**generateTestCases()**`:产生测试信息。这些应该用 Python `**email.mime.***`包中的 **`MIME*`** 类或`**email.message**`包中的`**Message**`类生成，以确保邮件消息有效。
    *   `**active**`:如果测试应处于活动状态，则为布尔值。
    *   **`identifier`** :测试的短标识符。这个用于启用或禁用参数测试。
    *   `**name**`:简考题。
    *   `**description**`:更长的测试描述，应在大约 100 个字符以内。
    *   `**delivery_sender**`和 **`delivery_recipient`** :布尔值，*默认为假*。通常，发送者和接收者是在消息中设置的，Python SMTP 模块从那里接管它们。有时需要在 SMTP 库中显式地设置它们，这可以通过将这些值设置为 *True* 来配置。
    *   `**finalizeMessage(msg)**`:默认情况下，基础测试类相应地设置从和*到*头的*。如果测试用例需要的话，这个行为可以被覆盖。*
*   `**MailAttachmentTestBase**`:附件测试用例的测试类。这将生成一个完整的有效邮件，包含一个主题和一个文本部分，并将测试用例附加到其中。派生自`**MailTestBase**`，因此它的方法/变量也可以在这里被覆盖。
    *   `**generateAttachments()**`:以(描述，附件)元组的形式产生测试用例。
    *   **`subject`** :设置主题。占位符`{}`被`**generateAttachments()**`生成的描述替换。
    *   `**generateTestCases()**`:已经被上述消息生成的实现所覆盖，但是如果需要，可以进一步修改。

强烈建议设置生成邮件的主题，以便能够识别接收收件箱中的测试。

### **逃避**

规避类实现了通过邮件安全解决方案规避对特定邮件属性的识别的技术。目前，实现了一种规避技术，该技术试图通过故意破坏*内容处置*报头来隐藏此类解决方案的附件。

#### **实施新的规避措施**

规避是由工厂类模式实现的。 **`DeliveryBase`** 类实例化一个从`BaseEvasionFactory`类派生的工厂类。工厂构造函数接收一个标志，该标志指示规避是否被激活。然后，规避工厂实例被传递给测试类，并存储在它的`evasions`属性中，该属性包含一个以规避标识符作为关键字的字典。在测试内部，用 **`getEvasionGenerator()`** 实例化了一个规避类(基于`**EvasionBase**`)。每个回避技术都单独定义了构造函数参数。

以下基类用于实现回避:

*   `**BaseEvasionFactory**`:闪避工厂必须基于这个类。通常，只应设置以下类变量:
    *   **`active`** :设置为*真*若闪避应激活。
    *   `**identifier**`:回避模块的短标识符，用于在测试配置中启用回避模块。
    *   **`name`** :闪避术的简称。
    *   更长的闪避技术描述。应该能容纳大约 100 个字符。
    *   **`generator_evasion`** :启用规避时实例化的规避类。
    *   `**generator_default**`:如果回避被禁用，则被实例化的回避类。
*   `**BaseEvasion**`:规避的实现必须是这个基类的子类。必须重写以下方法:
    *   `**__init__()**`:应该用基本消息或附件实例化该类，这些消息或附件应该用规避技术进行操作。
    *   `**generate()**`:对传递给构造函数的对象应用回避技术，并将其作为(描述，应用了回避的对象)元组让给调用者。

一般来说，规避类应该产生所有的规避变量，并通过默认的专用测试用例，而默认的规避类只通过给定的对象或创建所需的数据结构，如头。

#### **在测试用例中使用规避技术**

回避技术被用在测试用例中。例如，如果规避技术操纵邮件或附件的标题，则必须实施以下步骤:

1.  生成基本对象(邮件或附件),不考虑规避。
2.  利用`**self.evasions**` **中的规避工厂实例实例化适当的规避类，例如:`evasion_items = self.evasions["evasion_identifier"].getEvasionGenerator(message)`**
3.  迭代生成器并生成测试用例:

```
for evasion_item in evasion_items:
    yield evasion_item
```

#### **内容处置规避技术的使用**

内容处置规避技术已经在框架中实现，应该用于所有以识别恶意附件为目标的测试用例。构造函数接收附件和预期的文件名。然后，规避类产生(规避名称，应用规避技术的附件)元组，这些元组可以由 tests `**generateAttachments()**`方法直接产生。

## **免责声明**

不要用这个做邪恶的事！对云或其他托管解决方案的测试应始终由经过测试的提供商批准。只使用你自己的测试账户，不要用一堆测试邮件来烦任何人。

[![](img/d861a9096555aeb1980fc054015933d7.png)](https://github.com/TKCERT/mail-security-tester)