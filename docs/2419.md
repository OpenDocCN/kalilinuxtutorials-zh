# DRAKVUF 沙箱:自动化管理程序级恶意软件分析系统

> 原文：<https://kalilinuxtutorials.com/drakvuf-sandbox-automated-hypervisor-level-malware-analysis-system/>

[![](img/db41111fd63bf5b44eb3330cc116b897.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEipXDmcIBb22omN-Yj9k7NySMMbPDuwepJW87QMMM6prm2M77UN6ySMj8qhzU3PxnQ30vqkpjkLWgWDegYqiNZSoXzCzb2BleH5IEfxvV6snEA2i7MynSb43a3ppO2ut63C-XIvFLH59GWgA6bqVkXxcv4Q0lbr409q3ge-EaJbya4OD_7lDvGFupM8/s728/download%20(1).png)

**DRAKVUF 沙箱**是一个自动化的黑盒恶意软件分析系统，在引擎盖下有 DRAKVUF 引擎，它不需要客户操作系统上的代理。

这个项目为您提供了一个友好的网络界面，允许您上传可疑文件进行分析。一旦沙盒工作完成，您可以通过提到的界面探索分析结果，并深入了解文件是否真正是恶意的。

因为设置恶意软件沙箱通常很难，所以该项目还为您提供了一个安装程序应用程序，它将指导您完成必要的步骤，并使用推荐给初学者的设置来配置您的系统。同时，有经验的用户可以调整一些设置，甚至更换一些基础设施部件，以更好地满足他们的需求。

## 支持的硬件和软件

为了运行 DRAKVUF 沙盒，您的设置必须满足所有列出的要求:

*   处理器:具有 VT-x 和 EPT 特性的英特尔处理器(如何检查)。
*   主机系统:Debian 10 Buster/Ubuntu 18.04 Bionic/Ubuntu 20.04 Focal 至少 2 核 CPU 和 5 GB RAM，运行 GRUB 作为引导加载程序。
*   来宾系统:Windows 7 (x64)、Windows 10(x64；实验支持)

嵌套虚拟化:

*   KVM **确实可以工作，但是它被认为是实验性的。如果您遇到任何错误，请向我们报告，以便进一步调查。**
*   由于缺乏公开的 CPU 特性，在云中托管 DRAKVUF 沙箱**不支持**(尽管将来可能会改变)。
*   Hyper-V 不工作。
*   Xen **可以开箱即用吗？**
*   VMware Workstation Player **可以工作，但是您需要检查虚拟机的虚拟化 EPT 选项；仍然需要含 EPT 的英特尔处理器。**

## 基本安装

本说明假设您想要创建一个具有默认组件的单节点安装，这是推荐给初学者的。

*   下载最新发布的软件包。
*   安装龙套:

**# apt 更新
# apt 安装。/drak vu-bundle *。deb
#重启**

*   安装 DRAKVUF 沙盒堆栈:

apt install redis 服务器
apt install。/drakcore *。deb apt install。/drakron*。deb〔T4〕

*   检查您的 Xen 安装是否兼容。该命令应该打印“所有测试通过”:

**draksetup test**

执行:

**drak setup install/opt/path _ to _ windows . iso**

仔细阅读命令的输出。此命令将运行带有 Windows 系统的虚拟机安装过程。

**定制 vcpu/内存:**您可以传递附加选项，以便定制每个虚拟机的 vcpu 数量(`**--vcpus <number>**`)和内存量(`**--memory <num_mbytes>**`)。比如:`**--vcpus 1 --**` **`memory 2048`。**

*已知与 DRAKVUF 沙箱一起正常工作的推荐最小值:*

| 系统版本 | 最小 vCPUs | 最小内存 |
| --- | --- | --- |
| Windows 7 | one | One thousand five hundred and thirty-six |
| Windows 10 | Two | Three thousand and seventy-two |

**无人值守安装:**如果你有`**autounattend.xm**l`匹配你的 Windows ISO，你可以通过添加`**--unattended-xml /path/to/autounattend.xml**`请求无人值守安装。无人参与安装配置可以用 Windows 应答文件生成器生成。

使用 VNC 连接到安装进程:

vncviewer localhost:5900

*   执行 Windows 安装，直到引导至桌面。
*   可选:此时，您可以选择安装额外的软件。您可以执行:

```
draksetup mount /path/to/some-cd.iso

```

*   这将把包含附加软件的虚拟 CD 盘挂载到您的虚拟机中。
*   **可选:**生成。NET Framework 本机映像缓存，方法是在虚拟机的管理提示符下执行以下命令。

```
cd C:\Windows\Microsoft.NET\Framework\v4.0.30319
ngen.exe executeQueuedItems
cd C:\Windows\Microsoft.NET\Framework64\v4.0.30319
ngen.exe executeQueuedItems

```

为了完成虚拟机设置过程，请执行:

**draksetup postinstall**

通过导航到 web 界面(http://localhost:6300/)并上传一些示例来测试您的安装。默认分析时间为 10 分钟。

# 可选功能

本节包含关于在设置 DRAKVUF 沙箱时可能启用的可选功能的各种信息。

## ZFS 存储后端

如果您想安装带有 ZFS 存储后端的 DRAKVUF 沙箱，您应该在执行 **`draksetup install`** 命令之前执行以下额外步骤:

*   在你的机器上安装 ZFS(指南:Debian Buster，Ubuntu 18.04)
*   在空闲分区上创建 ZFS 池

```
zpool create tank <partition_name>
```

*   其中`**<partiton_name>**`例如是`**/dev/sda3**`。请注意，存储在所选分区上的所有数据都可能被擦除。
*   为 DRAKVUF 沙箱创建数据集

执行“基本安装”部分中的`**draksetup install**`,但记住提供额外的命令行开关:

**–存储-后端 ZFS–ZFS-tank-name tank/VMs**

**联网**

总是:

*   每个`**drakrun@<vm_id>**`实例将创建一个网桥`**drak<vm_id>**`，为其分配`**10.13.<vm_id>.1/24**` IP 地址/子网，并启动接口。
*   `**drakrun**`将丢弃来自`**drak<vm_id>**`网桥的任何输入流量，除了 DHCP 流量(UDP 端口:67、68)。

仅用 **`net_enable=1` :**

*   `**drakrun**`将启用 IPv4 转发。
*   `**drakrun**`将通过`**out_interface**`为来自 **`10.13.<vm_id>.0/24`的数据包配置伪装。**
*   `**drakrun**`将为`**X != Y**`中断`**drak<X>**`和`**drak<Y>**`桥之间的交通。

为了找出网络配置的确切细节，在`**drakrun/drakrun/main.py**`文件中搜索`**_add_iptable_rule**`功能用法。

### 基本网络

如果您希望您的客户虚拟机访问互联网，您可以通过编辑`**/etc/drakrun/config.ini**`中的`**[drakrun]**`部分来启用联网:

*   设置`**net_enable=1**`以启用访客互联网访问。
*   检查是否正确检测到`**out_interface**`(例如`**ens33**`)，如果没有，请纠正该设置。

对`**/etc/drakrun**`进行更改后，您需要重新启动系统中正在运行的所有`**drakrun**`服务

请注意，如果您的沙盒实例已经在运行一些分析，上面的命令将优雅地等待几分钟，直到这些分析完成。

### 使用 dnschef

您可以选择配置您的客人使用 dnschef。

*   设置 dnmanager 工具。
*   以这种方式启动`**dnschef**`，使其监听所有属于 DRAKVUF 沙箱的 **`drak*`** 接口。
*   在`**/etc/drakrun/config.ini**`中设置`**dns_server=use-gateway-address**`。
*   重启你的 drakrun 实例:`**systemctl restart 'drakrun@***`。

## MS Office 文件支持

有分析 word 和 excel 样本的实验支持。但是，这要求您安装了 Microsoft Office。

在创建快照之前，应在来宾虚拟机上完成以下步骤(例如，在运行`**draksetup postinstall**`之前)。如果要修改现有的快照，请参考快照修改。

*   安装 Microsoft Office。您可以在虚拟机安装期间使用`**draksetup mount /path/to/office.iso**`命令插入 Office 安装介质。安装后，您应该能够通过从命令行运行 **`start winword.exe`、`start excel.exe`、**来启动 word/excel。
*   通过执行以下命令来调整注册表项。注册文件:

## ProcDOT 集成

如果`**drakcore**`会发现它的二进制文件安装在 **`/opt/procdot/procmon2dot`上，DRAKVUF 沙箱可以选择使用 ProcDOT 绘制一个行为图。**

*   下载 procoat
*   使用您下载的`**procdot*_linux.zip**`归档文件，执行以下命令:
*   您的新分析报告还将包含行为图表。

# 管理快照

## 快照修改

在尝试修改安装之前，请确保所有的`**drakrun@**`服务都已停止。

以 root 身份执行`**drakplayground 0**`。该命令的输出应该类似于以下内容

**dnsmasq:已启动，版本 2.83 DNS 已禁用
dnsmasq:编译时选项:IPv6 GNU-get opt DBus no-UBus i18n IDN 2 DHCP DHCP V6 no-Lua TFTP conntrack ipset auth nettle hash DNSSEC loop-detect inotify dump file
DNS masq-DHCP:DHCP，IP 范围 10.13.0.100 — 10.13.0.200，租用时间 12h
DNS masq-DHCP:DH 专门绑定到接口 drak0
的套接字加载新的保存文件/var/lib/drakrun/volumes/snapshot . sav(new xl fmt info 0x 3/0x 0/2015)
保存文件包含 JSON 格式的 XL 域配置
解析来自/etc/drakrun/configs/VM-0 . CFG
xc:info:从 Xen 4.15
xc: info:正在恢复域
xc: info:恢复成功【t
您可以使用 VNC 连接到它(密码可以在/etc/drakrun/scripts/CFG . template 中找到)
运行 help()列出可用的命令**。

您将进入一个 IPython shell，运行 vm-0 并配置互联网连接。此时，您可以连接到 VNC 并执行修改。**不要退出**外壳或关闭终端。

如果您在主机上有一些脚本、可执行文件或其他文件，您可以使用助手功能将它们复制到虚拟机中

拷贝的文件应该出现在桌面上。

完成后，打开另一个终端窗口并执行`**draksetup postinstall**`。该命令将为其他虚拟机重新创建快照和配置文件。

现在关闭外壳是安全的。为此，请执行

```
exit()
```

## 导入和导出快照

当前的沙箱实现允许在一台机器上安装单个虚拟机快照。但是，可以从远程服务器导出和导入快照。

这在应该共享同一快照的多台机器上运行 drakrun 时特别有用。

快照有两种类型:最小和完整。在做任何事情之前，你应该知道哪一个适合你的用例。

### 最小快照

最小快照仅包含虚拟机最重要的部分，包括硬盘映像和虚拟机配置。

这既有优点也有缺点:

*   在新机器上使用快照之前，虚拟机必须冷启动到桌面，并且必须执行`**draksetup postinstall**`来提取运行时信息。
*   由于操作系统是在将用于执行分析的硬件上启动的，因此这种快照类型更加便携和稳定。

### 完整快照

完整快照包含`**drakrun**`正常工作所需的所有数据。除了配置和磁盘映像，它们还包含虚拟机物理内存和运行时信息的压缩转储。

导入完整快照后，不需要额外的步骤。

# 缩放比例

## 简介

执行安装后，默认情况下，您的沙盒实例将能够一次处理一个样本。执行实际分析的服务称为 drakrun@ <instance_number>。您可以通过执行以下命令来检查特定实例的状态:</instance_number>

**systemctl status drakru** n@1

您可以通过执行以下命令来更改并行工作进程的数量:

## 放大

假设您有一个实例，但是您希望能够并行处理 10 个样本，您应该执行:

```
draksetup scale 10
```

设置脚本将配置并启动从`**drakrun@2**`到`**drakrun@10**`的其他实例。

## 缩小比例

类似地，您可以通过对较少的实例重复相同的命令来缩小规模，例如:

```
draksetup scale 7
```

假设你之前有 10 个实例，这将导致`**drakrun@8**`到 **`drakrun@10`** 被禁用和关闭。如果对这些实例的分析处于挂起状态，该命令将优雅地等待，直到它完成。

## 后处理

分析后处理不需要虚拟机管理程序访问，因此可以在单独的服务器中完成，前提是它们具有相同的配置并连接到相同的 minio & redis 实例。如果您负担得起这样的设置，强烈建议您这样做，因为这可以释放运行虚拟机管理程序的服务器上的资源。

默认情况下，仅启动一个后处理工作进程实例，当运行多个 drakrun 实例时，需要进行扩展。根据经验，您可以假设后处理与 drakrun 工作人员的安全比率为 1:3(但是，该比率可能会根据平台的性能和分析持续时间而变化)。要启动更多的后处理实例，只需启动更多的`**drak-postprocess@**`服务实例。默认情况下只有 1 个，因此请确保根据您的需要进行相应的缩放。

# 升级

我们努力使安装和升级过程尽可能简单，因此为了使用新版本，您只需执行几个步骤。

升级沙盒之前，请停止沙盒工作进程:

**systemctl stop drakrun@***

安装新软件包并重新启动:

**易于安装。/drakvuf-bundle *。deb apt 安装。/德拉克伦*。deb
apt 安装。/drakcore*。deb
系统重启**

# 卡顿积分

## 连接到现有卡顿系统

在一个简单的安装中，DRAKVUF 沙箱依赖于 deb 包和一个本地 Redis 实例提供的服务。然而，它有可能与一个更大的，基于卡顿的管道集成。这样做只需要几个步骤:

*   停止所有正在运行的服务。
*   打开`**/etc/drakcore/config.ini**`，在`**[drakmon]**`部分设置`**system_disable=1**`。这将禁用本地`**karton-system**`实例。
*   将卡顿配置复制到`**/etc/drakcore/config.ini**`和`**/etc/drakrun/config.ini**`中的适当部分。
*   重新启动所有停止的服务。

## 建筑集成

要创建一个集成，需要熟悉 karton 库。在这里，您可以了解更多基本概念，如任务、标题或有效负载。

### 提交来自卡顿的样品

在默认配置中，drakrun 服务监听包含头的任务:

*   类型:样品
*   阶段:认可
*   平台:win32/win64

你可以在这里找到一个例子。

### 分析任务结构

在默认配置中，分析任务保证具有以下结构:标题:

*   类型:分析
*   孩子:drakrun

有效载荷:

*   `**sample**`–分析样本(资源)
*   `**[plugin_name].log**`–给定插件(资源)发出的 DRAKVUF 日志
    *   当插件被启用并生成一些输出时出现
*   `**dumps.zip**`–包含提取的内存转储的 ZIP 文件(资源)
*   `d**umps_metadata**`–带关键字的字典列表:(列表)
    *   `**base_address**`–转储的虚拟基址(十六进制)(字符串)
    *   `**filename**`–转储 ZIP 文件中文件的路径，相对于根目录
*   `**dumps.pcap**`–记录的网络流量(资源)
*   `**wireshark_key_file.txt**`–(资源)
    *   仅在 tlsmon 已启用且密钥已成功提取时出现
*   `**metadata**`–关于分析的基本事实(dict)；
    *   `**sample_sha256**`–己烯编码的 SHA256 分析样品总和(str)
    *   `**magic_output**`–样本的 libmagic 输出(str)
    *   `**time_started**`–分析开始的 UNIX 时间戳(int)
    *   `**time_finished**`–分析结束的 UNIX 时间戳(int)
    *   `**snapshot_versio**n`–虚拟机快照的 UNIX 时间戳(int)

# 了解沙盒

## 技术堆栈

DRAKVUF 沙盒建立在几层软件和硬件技术之上:

*   英特尔 VT-x 和 EPT–x64 架构的扩展，支持在 CPU 上本地运行虚拟机
*   Xen——虚拟机管理程序，产生虚拟机，并为交互和自省提供接口
*   LibVMI——抽象出自检接口，提供读/写虚拟机内存、解析虚拟机内核和处理虚拟机中发生的某些事件的通知的实用程序
*   DRAKVUF——悄悄地挂接一个来宾虚拟机的各个部分，并记录有趣的事件
*   DRAKVUF 沙盒–提供用户友好的界面和高级分析

## 项目结构

DRAKVUF 沙盒分为两个包:

*   drak core——系统核心，提供一个 web 界面、一个内部任务队列和对象存储
*   drakrun——沙盒工作程序，DRAKVUF 的包装程序，负责管理虚拟机、运行分析和发送结果以供进一步的后处理。

DRAKVUF 沙盒是围绕 karton 构建的——在 CERT Poland 创建的微服务框架，作为构建灵活的恶意软件分析管道的专用工具。它的主要目标是在多个服务之间路由任务。

## 守护进程

*   暗芯封装
    *   `**drak-web**`–允许用户通过 REST API 或 GUI 与沙箱交互的 web 界面
    *   `**drak-system**`——内部任务管理系统，用于在工人之间分派工作
    *   `**drak-minio**`–存储分析结果的内置对象存储器
    *   `**drak-postprocess**`–负责将原始分析日志处理成更有用的形式
*   德拉克伦包装
    *   `**drakrun 1..n**`–取来样品进行分析，运行 VMs，并发回分析结果；每个守护进程处理一个并发虚拟机

## 分析的生命周期

*   用户通过浏览器或使用 *karton* API 以编程方式提交新的分析。
*   `**drak-system**`将作业分派给`**drakrun**`实例之一。
*   `**drakrun**`运行分析:
    *   预配置的虚拟机映像已恢复
    *   使用 DRAKVUF 的`**injector**`将样本上传到虚拟机
    *   样本已执行
    *   在选定的超时后，虚拟机被销毁
*   原始结果(转储、日志、pcaps)作为一个*卡顿*任务被发送回`**drak-system**`。
*   `**drak-system**`向`**drak-postprocess**`分派任务，由`**drak-postprocess**`提取用户感兴趣的数据

# 沙盒开发

DRAKVUF 沙盒不是一个典型的单片应用程序。它被设计成部署在多个服务器上，既可以是独立的，也可以是更大的 karton 系统的一部分。多个组件和守护进程在开始时可能会令人困惑。

这是一个快速教程，应该可以帮助你开始开发沙盒。

DRAKVUF 沙盒是基于 karton 框架的。建议在接触沙盒代码之前熟悉它的概念。 <object>组件交互的高级视图

## Web 用户界面(drakcore)

作为用户提交样本和浏览结果的安贵。用 React 和超级自举主题构建。

代码位置:drakcore/drakcore/frontend

### 发展

先决条件是设置一个工作的 DRAKVUF 沙盒实例(MinIO、Redis、drakrun 和 API)。工作流将类似于用后端 API 开发其他基于 React 的应用程序。不要忘记在变化上跑得更漂亮。否则 CI 将拒绝您的代码。

```
cd drakcore/drakcore/frontend
$ *# install dependencies (execute only the first time)*
$ npm install
$ *# point the application at a running instance of API server*
$ export REACT_APP_API_SERVER=http://[API location]:6300/
$ *# start serving the frontend with live reloading*
$ npm start
```

## REST API(龙芯)

沙盒的主入口点。目标用户是 web UI 和与沙箱的编程集成。

代码位置:drakcore/drakcore/app.py

### 发展

REST API 是一个简单的基于 Flask 的 Python 应用程序。为了正常工作，它需要一个配置文件(存储在已配置的沙盒实例的`**/etc/drakcore/config.ini**`中)来访问 Karton 和 drakrun 工人。如果您想在不同于最初配置的机器上运行 API 服务器，您可能需要稍微调整一下。

```
# Create python virtualenv
$ python -m venv venv
$ source env/bin/activate
$ cd drakcore
$ # Copy the configuration file to the same directory as config.dist.ini
$ cp /some/config.ini drakcore/config.ini
$ # Install drakcore dependencies
$ pip install -r requirements.txt
$ # Install drakcore in editable mode
$ pip install -e .
$ export FLASK_APP=drakcore/app.py
$ export FLASK_ENV=development
$ flask run

```

## 龙(龙)

这是管理分析过程的主要组件，也是唯一需要部署在运行 Xen 的机器(虚拟或物理)上的组件。

代码位置:德拉克伦/德拉克伦

### 发展

这是最难开发的部分，因为它必须在单独的机器上运行。首先，在存储库中设置基本环境

```
*# Make sure that installed drakrun instance is not running*
$ systemctl stop drakrun@1
$ *# Create Python virtualenv*
$ python -m venv venv
$ source env/bin/activate
$ cd drakrun
$ *# Install drakrun dependencies*
$ pip install -r requirements.txt
$ *# Install drakrun in editable mode*
$ pip install -e .
$ *# Start drakrun*
$ python drakrun/main.py 1
```

德拉克鲁恩应该开始监听来自系统其他部分的新任务。在做了一些改变后，你必须重新开始这个过程。

要从您的主开发机器上开发 drakrun，您可以:

*   通过 SSHFS 挂载存储库目录
*   使用 IDE 集成来编辑远程文件
*   (高级)在一台工作机器上添加 drakrun 存储库作为另一个 Git remote，并推送更改

## 后处理(龙芯)

虚拟机管理程序的时间非常宝贵。这就是为什么在 drakrun 流程中执行尽可能少的工作很重要。分析后处理从 DRAKVUF 输出中提取感兴趣的数据，并将其转换为更易于前端使用的形式。

### 发展

在 drakrun 机器上:

```
# Make sure that the installed drak-postprocess instance is not running
$ systemctl stop drak-postprocess@1
```

# 回归测试

## 简介

内存转储是用于自动化恶意软件分析的核心功能之一。保存解包或解密后的内存，以便进一步利用 YARA 规则或配置提取进行分析。因此，重要的是要确保 DRAKVUF 的开发不会导致任何会破坏现有样本分析的回归。

## 准备测试集

回归测试集是一个 JSON 对象列表，它代表了许多样本提交和应该检测到的预期恶意软件家族名称。

转储分析是通过提供包含 malduck 提取器模块的目录来执行的。在这里，你可以更多地了解他们。

*   sha256–样本文件的 sha 256 哈希
*   扩展名–sanbox 支持的文件扩展名，例如“exe”或“dll”
*   ripped–恶意软件家族名称
*   path –(可选)恶意软件示例的路径

```
[
    {
        "sha256": "35e756ef1b3d542deaf59f093bc4abe5282a1294f7144b32b61f4f60c147cabb",
        "extension": "dll",
        "ripped": "emotet"
    },
    {
        "sha256": "4239335443cbf3d45db485d33c13346c67d5ac717a57856315a166c190dde075",
        "extension": "exe",
        "ripped": "raccoon",
        "path": "samples/4239335443cbf3d45db485d33c13346c67d5ac717a57856315a166c190dde075"
    }
```

测试提交者支持两种获取恶意软件样本的方法。

*   手动–如果测试用例定义了`**path**`键，恶意软件样本将从此位置读取(允许相对和绝对路径)。
*   自动–否则，将从 mwdb.cert.pl 服务下载样本。如果您打算使用此方法，请确保使用`**MWDB_API_KEY**`环境变量运行提交程序

## 运行接收器守护进程

首先，在`**/etc/drakrun/config.ini**`中配置提取器模块路径

# 建筑安装包

为了自己构建安装包，您必须首先在您的机器上安装 Docker。

## 龙雕沙盒〔龙雕〕〔t0〕

您可以使用以下命令从源代码构建软件包:

```
git clone https://github.com/CERT-Polska/drakvuf-sandbox.git
$ cd drakvuf-sandbox
$ sudo ./drakcore/package/build.sh
$ sudo ./drakrun/package/build.sh
```

然后，您应该会在 out/ directory 中找到您的安装包。

## 龙卷(龙卷)

drakvuf-bundle 的构建脚本是 tklengyel/drakvuf 存储库的一部分。您可以使用以下命令构建您的包:

```
git clone --recursive https://github.com/tklengyel/drakvuf
$ cd drakvuf
$ sudo ./package/build.sh
```

生成的包将被生成到`**package/out/**`目录。

# 使用 Drakpdb 工具

`**drakpdb**`工具允许您:

*   根据给定的可执行文件(如 DLL)确定 PDB 名称和 GUID 年龄
*   获取具有给定名称和 GUID 年龄的 PDB
*   将 PDB 解析成一个可以插入 DRAKVUF 的配置文件

[**Download**](https://github.com/CERT-Polska/drakvuf-sandbox)</object>