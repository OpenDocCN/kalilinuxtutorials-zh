# Process-Dump : Windows 工具，用于将恶意软件 PE 文件从内存转储回磁盘进行分析

> 原文：<https://kalilinuxtutorials.com/process-dump-windows-tool-for-dumping-malware-pe-files-from-memory-back-to-disk-for-analysis/>

[![](img/4813582df379f517e008000a9048cf71.png)](https://1.bp.blogspot.com/-xCypn0K5D5Q/YScpfk1VBSI/AAAAAAAAKlA/Xclba-iRyNY9xz6X974thWRMhPil6HNjQCLcBGAsYHQ/s728/48266433%2B%25281%2529.png)

**进程转储**是一个 Windows 逆向工程命令行工具，用于将恶意软件内存组件转储回磁盘进行分析。通常，恶意软件文件在被执行之前被打包和混淆，以避开反病毒扫描程序，然而，当这些文件被执行时，它们通常会在内存中解包或注入恶意软件代码的干净版本。恶意软件研究人员在分析恶意软件时的一个常见任务是将这些解压缩后的代码从内存转储到磁盘，以便用反病毒产品进行扫描或用 IDA 等静态分析工具进行分析。

进程转储适用于 Windows 32 和 64 位操作系统，可以从特定进程或当前运行的所有进程转储内存组件。进程转储支持创建和使用干净哈希数据库，因此可以跳过所有干净文件(如 kernel32.dll)的转储。它的主要特点包括:

*   从特定进程或所有进程转储代码。
*   查找并转储进程中未正确加载的隐藏模块。
*   查找并转储松散的代码块，即使它们与 PE 文件无关。它为块构建一个 PE 头和导入表。
*   使用积极的方法重建导入。
*   可以在关闭转储监视器模式('-closemon ')下运行，在这种模式下，进程将在终止前暂停并转储。
*   多线程，所以当你转储所有正在运行的进程时，速度会很快。
*   可以生成干净的哈希数据库。在计算机感染恶意软件之前生成此消息，以便进程转储仅转储新的恶意软件组件。

我在我的网站上维护一个官方编译的版本:[http://split-code.com/processdump.html](http://split-code.com/processdump.html)

**安装**

您可以在此下载最新编译的进程转储版本:

*   [http://www.split-code.com/files/pd_v2_1.zip](http://www.split-code.com/files/pd_v2_1.zip)

此工具需要安装 Microsoft Visual c++ re distributable for Visual Studio 2015 才能运行:

*   [https://www.microsoft.com/en-ca/download/details.aspx?id=48145](https://www.microsoft.com/en-ca/download/details.aspx?id=48145)

**编译源代码**

这是为 Visual Studio 2019 设计的，可与免费社区版配合使用。只要用 VS2019 打开项目文件，编译一下，应该就那么简单！

**例句用法**

转储系统上所有进程的所有模块和隐藏代码块(忽略已知的干净模块):

*   pd64.exe 系统

以终止监控模式运行。在取消(CTRL-C)之前，进程转储将在终止之前转储任何进程:

*   pd64.exe-克洛斯蒙

转储特定进程标识符中的所有模块和隐藏代码块:

*   pd64.exe-PID 0x18A

按进程名转储所有模块和隐藏代码块:

*   pd64.exe-p . *铬。*

构建干净哈希数据库。这些散列将用于通过上述命令排除模块转储:

*   pd64.exe 数据库 gen

PID 0x1a3 中特定地址的转储代码:

*   pd64.exe-PID 0x1a 3-a 0x FFB 4000
*   生成两个文件(32 位和 64 位),可以用生成的 PE 头和生成的导入表加载到 IDA 中进行分析:
*   notepad _ exe _ x64 _ hidden _ FFB 40000 . exe
*   记事本 _exe_x86_hidden_FFB40000.exe

**沙盒用法示例**

如果您正在运行自动沙盒或手动反恶意软件研究环境，我建议您运行以下带有进程转储的进程，以管理员身份运行所有命令:

*   在干净的环境中构建干净的哈希数据库:
*   pd64.exe 数据库 gen
*   (或更快)pd64 -db genquick
*   开始进程转储终止监控。让它在后台运行，转储恶意软件使用的所有中间进程:
*   pd64.exe-克洛斯蒙
*   运行恶意软件文件
*   观察恶意软件的安装(和 pd64 转储任何试图关闭的进程)
*   当您准备好从内存中转储正在运行的恶意软件时，运行以下命令转储所有进程:
*   pd64.exe 系统
*   所有转储的组件都将在 pd64.exe 的工作目录中。您可以使用'-o '标志来更改输出路径，

**关于转储模块命名约定的注释**

*   文件名中的“hiddemodule”而不是模块名表示模块没有在进程中正确注册。
*   文件名中的“codechunk”意味着它是从松散的可执行区域重新构建的转储。例如，这可以是没有 PE 头的注入代码。代码块将被转储两次，一次使用重构的 x86，另一次使用重构的 x64 头。

转储文件的文件名示例

*   notepad _ exe _ PID 2990 _ hidden module _ 16 b8 abb 0000 _ x86 . dll
*   notepad _ exe _ PID 3b 5c _ notepad . exe _ 7ff 6 e 6630000 _ x64 . exe
*   notepad _ exe _ pid2c 54 _ codechunk _ 17bd 0000 _ x86 . dll
*   notepad _ exe _ pid2c 54 _ codechunk _ 17bd 0000 _ x64 . dll

**帮助页面**

流程转储 v2.1 版权所有 2017，杰夫·麦克唐纳[http://www.split-code.com/](http://www.split-code.com/)

进程转储(pd.exe)是一个工具，用于将 32 位和 64 位可执行模块从进程地址空间内的内存转储回磁盘。该工具能够查找和转储隐藏模块以及松散的可执行代码块，并使用干净的哈希数据库来排除已知干净文件的转储。该工具使用一种积极的导入重建方法，将流程中指向导出的所有 DWORD/qword 链接到相应的导出函数。进程转储可用于从内存中转储所有未知代码('-system '标志)，转储特定的进程，或者在监控模式下运行，在进程终止前转储所有进程。

在第一次使用此工具之前，当在清理工作站上时，清理排除哈希数据库可以由以下任一方式生成:

*   pd -db gen
*   pd -db genquick

示例用法:

*   pd 系统
*   pd -pid 419
*   pd -pid 0x1a3
*   PD-PID 0x1a 3-a 0x 401000-o c:\ dump \-c c:\ dump \ test \ clean . db
*   chrome.exe 人民民主党
*   pd -p”(？我)。*铬合金。*"
*   pd -closemon

选项:

*   -系统

将所有可访问进程中与干净哈希数据库不匹配的模块转储到工作目录中。

*   -pid

将指定 pid 中与干净哈希数据库不匹配的所有模块转储到当前工作目录中。使用“0x”前缀指定十六进制 PID。

*   -克洛斯蒙

以监控模式运行。当任何进程终止时，进程转储将首先转储该进程。

*   -p

将进程名称中所有与干净哈希数据库不匹配的模块转储到当前工作目录，该进程名称与指定 pid 中的过滤器相匹配。

*   ——答

从进程中转储指定基址处的模块。

*   -g

强制从头开始生成 PE 头，忽略现有头。

*   -o<path></path>

为转储的组件设置默认输出根文件夹。

*   -v

啰嗦。

*   -nh

输出中不打印标题。

*   -nr

禁用哈希数据库目录上的递归添加或移除命令。

*   -倪

禁用导入重建。

*   -数控

禁用松散代码区域的转储。

*   -nt

禁用多线程。

*   -新经济政策

禁用入口点哈希。

*   -eprec

强制重建入口点，即使看起来存在一个有效的入口点。

*   -t<thread count=""></thread>

设置要使用的线程数(默认为 16)。

*   -国家开发银行<filepath></filepath>

用于此次运行的干净哈希数据库的完整文件路径。

*   -edb，T0

用于此次运行的入口点哈希数据库的完整文件路径。

*   -esdb<filepath></filepath>

用于此次运行的入口点短哈希数据库的完整文件路径。

*   -数据库版本

自动处理一些常见的文件夹以及所有当前正在运行的进程，并将找到的模块哈希添加到干净的哈希数据库中。它将递归添加% WINDIR % % HOMEPATH % C:\ Program Files
C:\ Program Files(x86)
中的所有文件，以及所有正在运行的进程中的所有模块

*   -db genquick

将所有进程中所有模块的哈希添加到干净的哈希数据库中。在干净的系统上运行这个。

*   -数据库添加

将指定目录中的所有文件递归添加到干净的哈希数据库中。

*   -db rem

从干净哈希数据库中递归移除指定目录中的所有文件。

*   -数据库清理

清除干净的哈希数据库。

*   -数据库忽略

这次转储进程时忽略干净的哈希数据库。即使找到匹配，所有模块都将被转储。

**版本历史**

**2.1 版本(2017 年 2 月 12 日)**

*   修正了一个错误，在某些情况下，最后一部分会被零填充。感谢 megastupidmonkey 报告此问题。
*   修复了一个 64 位基址将被截断为 32 位地址的错误。它现在可以正确地保留完整的 64 位模块基址。感谢 megastupidmonkey 报告此问题。
*   解决了进程转储关闭监视器会导致 csrss.exe 崩溃的问题。
*   在关闭监视模式下，停止进程转储挂钩它自己的进程。

**2.0 版本(2016 年 9 月 18 日)**

*   添加了新的标记'-closemon '，它在监控模式下运行进程转储。它会在关闭时暂停并转储任何进程。这是为恶意软件分析沙箱设计的，以确保在恶意程序关闭之前从内存中清除恶意软件。
*   将进程转储升级为多线程。从多个进程转储或获取哈希的命令将在每个操作中运行单独的线程。默认线程数是 16，这大大加快了一般进程转储处理的速度。
*   升级了进程转储，转储内存中找到的未附加的代码块。这些被标识为内存中的可执行区域，它们没有连接到模块，也没有 PE 头。它还要求代码块引用至少两个被认为有效的导入，以便减少噪声。转储时，PE 头和导入表一起被重新创建。干净哈希数据库完全支持代码块。
*   添加了标记来控制干净哈希数据库的文件路径以及转储文件的输出文件夹。
*   修复了从导致崩溃的用户路径生成干净哈希数据库的问题。
*   修正了强制生成 PE 头的标志“-g”。即使设置了此标志，系统转储(-system)也会在转储进程时忽略此标志。
*   各种性能改进。
*   已将项目升级到 VS2015。

**1.5 版(2015 年 11 月 21 日)**

*   修正了非常大的内存区域会导致进程转储挂起的错误。
*   修正了在 64 位 Windows 下一些高地址的模块不能被发现的错误。
*   更多的调试信息现在在详细模式下输出。

**1.4 版本(2015 年 4 月 18 日)**

*   增加了新的积极的进口重建方法。现在，将模块中的所有 DWORDs 和 QWORDs 修补为相应的导出匹配。
*   添加了“-a(要转储的地址)”标志来转储特定地址。它将生成 PE 头并为该地址构建一个导入表。
*   添加了'-ni '标志以跳过新的导入重建算法。
*   添加了'-g '标志，以强制生成新的 PE 头，即使在转储模块时已经存在一个 PE 头。例如，如果 PE 头格式不正确，这就很好。
*   各种错误修复。

**1.3 版本(2013 年 10 月 10 日)**

*   改进了对指定无效虚拟大小和地址的 PE 头的处理。
*   更好的模块转储方法，用于将虚拟分区转储到磁盘分区。

**1.1 版本(2013 年 4 月 8 日)**

*   修复了与 Windows XP 的兼容性问题。
*   修正了进程转储会显示它正在转储一个模块，但实际上并没有转储的错误。
*   实现了'-pid '转储标志。

**1.0 版本(2013 年 4 月 2 日)**

*   初次发布。

[**Download**](https://github.com/glmcdona/Process-Dump)